<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Meril Ecosystem</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .sidebar-active {
            background-color: #4f46e5;
            color: white;
        }

        .sidebar-item:hover:not(.sidebar-active) {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #68D391;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-md flex flex-col z-10">
        <div class="h-16 flex items-center justify-center border-b border-gray-200">
            <i class="fas fa-shield-alt text-indigo-600 text-2xl mr-2"></i>
            <span class="font-bold text-xl text-gray-800 tracking-tight">Meril Admin</span>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <p class="px-6 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Overview</p>
            <a href="#" onclick="showSection('dashboard')" id="nav-dashboard"
                class="sidebar-item sidebar-active flex items-center px-6 py-3 text-sm font-medium transition-colors">
                <i class="fas fa-chart-pie w-5 mr-3"></i> Dashboard
            </a>

            <p class="px-6 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-6 mb-2">Tools Configuration
            </p>
            <a href="#" onclick="showSection('tool-cardio')" id="nav-tool-cardio"
                class="sidebar-item flex items-center px-6 py-3 text-gray-600 text-sm font-medium transition-colors">
                <i class="fas fa-heartbeat w-5 mr-3"></i> Cardio Validator
            </a>
            <a href="#" onclick="showSection('tool-mdpl')" id="nav-tool-mdpl"
                class="sidebar-item flex items-center px-6 py-3 text-gray-600 text-sm font-medium transition-colors">
                <i class="fas fa-file-medical w-5 mr-3"></i> MDPL Validator
            </a>
            <a href="#" onclick="showSection('tool-mhpl')" id="nav-tool-mhpl"
                class="sidebar-item flex items-center px-6 py-3 text-gray-600 text-sm font-medium transition-colors">
                <i class="fas fa-hospital w-5 mr-3"></i> MHPL Validator
            </a>
            <a href="#" onclick="showSection('tool-mlsipl')" id="nav-tool-mlsipl"
                class="sidebar-item flex items-center px-6 py-3 text-gray-600 text-sm font-medium transition-colors">
                <i class="fas fa-flask w-5 mr-3"></i> MLSIPL Validator
            </a>
            <a href="#" onclick="showSection('tool-chat')" id="nav-tool-chat"
                class="sidebar-item flex items-center px-6 py-3 text-gray-600 text-sm font-medium transition-colors">
                <i class="fas fa-comments w-5 mr-3"></i> Chat App
            </a>

            <p class="px-6 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-6 mb-2">User Management</p>
            <a href="#" onclick="showSection('users')" id="nav-users"
                class="sidebar-item flex items-center px-6 py-3 text-gray-600 text-sm font-medium transition-colors">
                <i class="fas fa-user-plus w-5 mr-3"></i> Add Users
            </a>

            <p class="px-6 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-6 mb-2">System</p>
            <a href="#" onclick="showSection('settings')" id="nav-settings"
                class="sidebar-item flex items-center px-6 py-3 text-gray-600 text-sm font-medium transition-colors">
                <i class="fas fa-cogs w-5 mr-3"></i> Global Settings
            </a>
        </nav>

        <div class="p-4 border-t border-gray-200 space-y-2">
            <!-- Back to Home -->
            <button onclick="window.location.href='index.html'"
                class="w-full flex items-center justify-center px-4 py-2 border border-blue-200 text-blue-700 bg-blue-50 hover:bg-blue-100 text-sm font-medium rounded-md shadow-sm transition-colors">
                <i class="fas fa-home mr-2"></i> Back to Home
            </button>

            <!-- Logout -->
            <button onclick="handleLogout()"
                class="w-full flex items-center justify-center px-4 py-2 border border-red-200 text-red-700 bg-red-50 hover:bg-red-100 text-sm font-medium rounded-md shadow-sm transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i> Logout
            </button>

            <!-- Admin Profile (Mini) -->
            <div class="flex items-center pt-2 mt-2 border-t border-gray-100">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-xs shadow-sm"
                    id="admin-avatar">A</div>
                <div class="ml-3 min-w-0">
                    <p class="text-sm font-bold text-gray-900 truncate" id="admin-name">Loading...</p>
                    <p class="text-xs text-gray-500 truncate flex items-center">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span> Online
                    </p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100">

        <!-- Loading Overlay -->
        <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
            <div class="text-center">
                <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-600 mb-4"></i>
                <p class="text-gray-500">Verifying privileges...</p>
            </div>
        </div>

        <!-- Access Denied -->
        <div id="access-denied" class="hidden fixed inset-0 bg-red-50 z-50 flex items-center justify-center">
            <div class="text-center max-w-md p-6 bg-white rounded-lg shadow-xl">
                <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Access Denied</h2>
                <p class="text-gray-600 mb-6">You do not have permission to view this page. Administrator access is
                    required.</p>
                <a href="index.html"
                    class="inline-block bg-indigo-600 text-white px-6 py-2 rounded shadow hover:bg-indigo-700 transition">Return
                    to Home</a>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="view-section px-8 py-6">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">System Dashboard</h1>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Stat Card 1 -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-indigo-500 rounded-md p-3">
                                <i class="fas fa-users text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Users</dt>
                                    <dd class="text-3xl font-semibold text-gray-900" id="stat-users">-</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stat Card 2 -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-green-500 rounded-md p-3">
                                <i class="fas fa-database text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Active Configs</dt>
                                    <dd class="text-3xl font-semibold text-gray-900" id="stat-configs">-</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stat Card 3 -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-yellow-500 rounded-md p-3">
                                <i class="fas fa-tools text-white text-xl"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">System Status-</dt>
                                    <dd class="text-lg font-semibold text-green-600 mt-1">Operational</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Table -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Recent Configuration Changes</h3>
                </div>
                <ul id="activity-list" class="divide-y divide-gray-200">
                    <li class="px-6 py-4 text-center text-gray-500 text-sm">Loading activity...</li>
                </ul>
            </div>
        </div>

        <!-- USER MANAGEMENT VIEW -->
        <div id="view-users" class="view-section hidden px-8 py-6">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">User Management</h1>

            <div class="bg-white shadow rounded-lg max-w-2xl">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h3 class="text-lg font-medium text-gray-900">Create New User</h3>
                    <p class="text-sm text-gray-500">Add a new user to the system. They will receive a confirmation
                        email.</p>
                </div>
                <div class="p-6">
                    <form id="createUserForm" onsubmit="handleCreateUser(event)" class="space-y-4">

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Name -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="new-user-name" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-2">
                            </div>

                            <!-- Role -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Role</label>
                                <select id="new-user-role"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-2">
                                    <option value="user">Standard User</option>
                                    <option value="admin">Administrator</option>
                                </select>
                            </div>
                        </div>

                        <!-- Email -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="new-user-email" required placeholder="user@merillife.com"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-2">
                        </div>

                        <!-- Password -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="new-user-pass" required minlength="6"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-2">
                        </div>

                        <!-- Actions -->
                        <div class="pt-4 flex items-center justify-end">
                            <button type="submit" id="btn-create-user"
                                class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 font-medium shadow-sm transition-colors">
                                <i class="fas fa-plus mr-2"></i> Create Account
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="user-msg-container" class="mt-4 max-w-2xl"></div>
        </div>

        <!-- GENERIC TOOL EDITOR VIEW -->
        <div id="view-tool-editor" class="view-section hidden px-8 py-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900" id="editor-title">Tool Configuration</h1>
                    <p class="text-sm text-gray-500" id="editor-subtitle">Manage settings for this tool.</p>
                </div>
                <div class="space-x-2">
                    <div class="inline-flex rounded-md shadow-sm" role="group">
                        <button onclick="setVisibleEditorMode('visual')" id="btn-mode-visual"
                            class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700">
                            <i class="fas fa-sliders-h mr-1"></i> Visual
                        </button>
                        <button onclick="setVisibleEditorMode('code')" id="btn-mode-code"
                            class="px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-l-0 border-gray-300 rounded-r-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700">
                            <i class="fas fa-code mr-1"></i> Code
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-2 mb-4">
                <button onclick="resetEditor()"
                    class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Discard Changes
                </button>
                <button onclick="loadTemplate()"
                    class="px-4 py-2 border border-blue-300 rounded-md shadow-sm text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100">
                    <i class="fas fa-magic mr-1"></i> Load Template
                </button>
                <button onclick="saveCurrentConfig()"
                    class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-save mr-2"></i> Save Changes
                </button>
            </div>

            <!-- VISUAL EDITOR CONTAINER -->
            <div id="visual-editor-container" class="bg-white shadow rounded-lg overflow-hidden p-6 hidden">
                <div id="visual-controls" class="space-y-6">
                    <!-- Dynamic Controls Will Be Injected Here -->
                </div>
            </div>

            <!-- JSON EDITOR CONTAINER -->
            <div id="json-editor-container" class="bg-white shadow rounded-lg overflow-hidden hidden">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-500">Configuration JSON</span>
                    <span class="text-xs text-gray-400 font-mono" id="config-key-display">Key: -</span>
                </div>
                <div class="p-0">
                    <textarea id="json-editor"
                        class="w-full h-96 p-4 font-mono text-sm border-0 focus:ring-0 resize-none bg-gray-50"
                        spellcheck="false"></textarea>
                </div>
            </div>

            <div class="mt-4 text-right">
                <span id="save-status" class="text-sm text-green-600 font-medium hidden">Saved successfully!</span>
            </div>
        </div>

    </main>

    <!-- JS Logic -->
    <script>
        const SUPABASE_URL = 'https://etdqyrkihsbritcikpbi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0ZHF5cmtpaHNicml0Y2lrcGJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTMxNzksImV4cCI6MjA4NjAyOTE3OX0.gNVhroMQpc_2Yl3p8UyjdalTqzeUHvLgjcu-XxBWI1I';
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentConfigKey = null;
        let currentEditorMode = 'visual'; // 'visual' or 'code'

        // Tool Metadata Mapping
        const TOOL_MAP = {
            'tool-cardio': { key: 'cardio_settings', name: 'Cardio Validator', desc: 'Heart rate limits, default thresholds, etc.' },
            'tool-mdpl': { key: 'mdpl_settings', name: 'MDPL Validator', desc: 'MDPL specific compliance rules.' },
            'tool-mhpl': { key: 'mhpl_settings', name: 'MHPL Validator', desc: 'Hospital list and validation parsing rules.' },
            'tool-mlsipl': { key: 'mlsipl_settings', name: 'MLSIPL Validator', desc: 'System integration endpoints.' },
            'tool-chat': { key: 'chat_settings', name: 'Chat Application', desc: 'Message retention, file size limits, etc.' },
            'settings': { key: 'global_settings', name: 'Global Settings', desc: 'System-wide preferences.' }
        };

        // Default Templates
        const TEMPLATES = {
            'cardio_settings': {
                "enabled": true,
                "features": {
                    "allow_clear_data": true,
                    "allow_switch_entity": true,
                    "allow_local_config": true,
                    "allow_layout_manager": true,
                    "allow_export": true,
                    "show_scanner_doctor": true
                }
            },
            'mdpl_settings': {
                "enabled": true,
                "features": {
                    "allow_clear_data": true,
                    "allow_switch_entity": true,
                    "allow_local_config": true,
                    "allow_layout_manager": true,
                    "allow_export": true,
                    "show_scanner_doctor": true
                }
            },
            'mhpl_settings': {
                "enabled": true,
                "features": {
                    "allow_clear_data": true,
                    "allow_switch_entity": true,
                    "allow_local_config": true,
                    "allow_layout_manager": true,
                    "allow_export": true,
                    "show_scanner_doctor": true
                }
            },
            'mlsipl_settings': {
                "enabled": true,
                "version": "v1",
                "endpoint_url": "https://api.example.com/mlsipl",
                "api_key": "",
                "features": {
                    "allow_clear_data": true,
                    "allow_switch_entity": true,
                    "allow_local_config": true,
                    "allow_layout_manager": true,
                    "allow_export": true,
                    "show_scanner_doctor": true
                }
            },
            'chat_settings': {
                "enabled": true,
                "retention_days": 30,
                "max_file_size_mb": 10,
                "features": {
                    "allow_file_upload": true,
                    "allow_delete_msg": true,
                    "allow_file_sharing": true,
                    "allow_markdown": true
                }
            },
            'global_settings': {
                "system_name": "Meril Ecosystem",
                "maintenance_mode": false,
                "announce_message": ""
            }
        };

        // Initialize Admin Dashboard
        async function init() {
            try {
                const { data: { user } } = await sbClient.auth.getUser();
                if (!user) throw new Error("No user");

                // Check Role
                const { data: profile } = await sbClient
                    .from('profiles')
                    .select('role, username')
                    .eq('id', user.id)
                    .single();

                if (!profile || profile.role !== 'admin') {
                    // STRICT: Redirect immediately
                    window.location.href = 'index.html';
                    return;
                }

                currentUser = user;
                document.getElementById('admin-name').innerText = profile.username || user.email.split('@')[0];
                document.getElementById('admin-avatar').innerText = (profile.username || user.email).charAt(0).toUpperCase();

                document.getElementById('loading').classList.add('hidden');

                loadDashboardStats();

            } catch (e) {
                console.error("Auth failed:", e);
                // Redirect on error too for safety
                window.location.href = 'index.html';
            }
        }

        window.loadTemplate = function () {
            if (confirm("This will overwrite current editor content with the default template. Continue?")) {
                const template = TEMPLATES[currentConfigKey] || {};
                const jsonStr = JSON.stringify(template, null, 2);
                document.getElementById('json-editor').value = jsonStr;
                renderVisualEditor(template); // Update visual
            }
        }

        window.setVisibleEditorMode = function (mode) {
            currentEditorMode = mode;
            const visualBtn = document.getElementById('btn-mode-visual');
            const codeBtn = document.getElementById('btn-mode-code');
            const visualContainer = document.getElementById('visual-editor-container');
            const jsonContainer = document.getElementById('json-editor-container');

            if (mode === 'visual') {
                visualBtn.classList.replace('text-gray-500', 'text-gray-900');
                codeBtn.classList.replace('text-gray-900', 'text-gray-500');

                // Sync Code -> Visual
                try {
                    const json = JSON.parse(document.getElementById('json-editor').value);
                    renderVisualEditor(json);
                    visualContainer.classList.remove('hidden');
                    jsonContainer.classList.add('hidden');
                } catch (e) {
                    alert("Invalid JSON in Code Editor. Please fix before switching to Visual Mode.");
                    return;
                }

            } else {
                codeBtn.classList.replace('text-gray-500', 'text-gray-900');
                visualBtn.classList.replace('text-gray-900', 'text-gray-500');

                // Sync Visual -> Code (Assuming visual updates JSON on change, so just show)
                visualContainer.classList.add('hidden');
                jsonContainer.classList.remove('hidden');
            }
        }

        function renderVisualEditor(config) {
            const container = document.getElementById('visual-controls');
            container.innerHTML = ''; // Clear

            // Helper to create toggle
            function createToggle(key, label, value, onChange) {
                const wrapper = document.createElement('div');
                wrapper.className = "flex items-center justify-between py-3 border-b border-gray-100 last:border-0";

                const labelDiv = document.createElement('div');
                labelDiv.innerHTML = `<p class="text-sm font-medium text-gray-900">${label}</p><p class="text-xs text-gray-500 font-mono">${key}</p>`;

                const toggleLabel = document.createElement('label');
                toggleLabel.className = "relative inline-flex items-center cursor-pointer";

                const input = document.createElement('input');
                input.type = "checkbox";
                input.className = "sr-only peer";
                input.checked = value;
                input.onchange = (e) => onChange(e.target.checked);

                const slider = document.createElement('div');
                slider.className = "w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600";

                toggleLabel.appendChild(input);
                toggleLabel.appendChild(slider);

                wrapper.appendChild(labelDiv);
                wrapper.appendChild(toggleLabel);
                return wrapper;
            }

            // Helper to create textarea
            function createTextArea(key, label, value, onChange) {
                const wrapper = document.createElement('div');
                wrapper.className = "py-3 border-b border-gray-100 last:border-0";

                const labelEl = document.createElement('label');
                labelEl.className = "block text-sm font-medium text-gray-700 mb-1";
                labelEl.innerText = label;

                const subLabel = document.createElement('p');
                subLabel.className = "text-xs text-gray-500 font-mono mb-2";
                subLabel.innerText = key;

                const textarea = document.createElement('textarea');
                textarea.className = "w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border font-mono text-xs";
                textarea.rows = 6;
                textarea.value = value || "";
                textarea.placeholder = "Paste CSV data here...";
                textarea.oninput = (e) => onChange(e.target.value);

                wrapper.appendChild(labelEl);
                wrapper.appendChild(subLabel);
                wrapper.appendChild(textarea);
                return wrapper;
            }

            // Helper to create input field
            function createInput(key, label, value, onChange) {
                const wrapper = document.createElement('div');
                wrapper.className = "py-3 border-b border-gray-100 last:border-0";

                const labelEl = document.createElement('label');
                labelEl.className = "block text-sm font-medium text-gray-700 mb-1";
                labelEl.innerText = label;

                const subLabel = document.createElement('p');
                subLabel.className = "text-xs text-gray-500 font-mono mb-2";
                subLabel.innerText = key;

                const input = document.createElement('input');
                input.type = typeof value === 'number' ? 'number' : 'text';
                input.className = "w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2 border";
                input.value = value;
                input.oninput = (e) => onChange(input.type === 'number' ? parseFloat(e.target.value) : e.target.value);

                wrapper.appendChild(labelEl);
                wrapper.appendChild(subLabel);
                wrapper.appendChild(input);
                return wrapper;
            }

            // Universal Control Creator
            function createControl(key, value, parentObj) {
                if (key === 'features') return; // Handled separately
                if (key === 'version') return; // Skip version

                // Special handling for CSV fields
                if (key.includes('_csv') || key === 'master_data' || key === 'rules_data') {
                    container.appendChild(createTextArea(key, formatLabel(key), value, (newVal) => {
                        parentObj[key] = newVal;
                        updateJsonFromVisual(config);
                    }));
                    return;
                }

                if (typeof value === 'boolean') {
                    container.appendChild(createToggle(key, formatLabel(key), value, (newVal) => {
                        parentObj[key] = newVal;
                        updateJsonFromVisual(config);
                    }));
                } else if (typeof value === 'string' || typeof value === 'number') {
                    container.appendChild(createInput(key, formatLabel(key), value, (newVal) => {
                        parentObj[key] = newVal;
                        updateJsonFromVisual(config);
                    }));
                }
            }

            // 1. Render Root Properties
            const rootHeader = document.createElement('div');
            rootHeader.innerHTML = '<h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">General</h3>';
            container.appendChild(rootHeader);

            Object.keys(config).forEach(key => {
                if (key !== 'features') {
                    createControl(key, config[key], config);
                }
            });

            // 2. Render Features Object
            if (config.features) {
                const featuresHeader = document.createElement('h3');
                featuresHeader.className = "text-xs font-bold text-gray-400 uppercase tracking-wider mt-6 mb-2 border-t pt-4";
                featuresHeader.innerText = "Features Configuration";
                container.appendChild(featuresHeader);

                Object.keys(config.features).forEach(key => {
                    createControl(key, config.features[key], config.features);
                });
            }
        }

        function formatLabel(key) {
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function updateJsonFromVisual(config) {
            document.getElementById('json-editor').value = JSON.stringify(config, null, 2);
        }

        // Navigation Logic
        window.showSection = function (sectionId) {
            // Update Sidebar
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('sidebar-active', 'bg-indigo-600', 'text-white'));
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.add('text-gray-600'));

            const activeLink = document.getElementById(`nav-${sectionId}`);
            if (activeLink) {
                activeLink.classList.add('sidebar-active');
                activeLink.classList.remove('text-gray-600');
            }

            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));

            if (sectionId === 'dashboard') {
                document.getElementById('view-dashboard').classList.remove('hidden');
                loadDashboardStats();
            } else if (sectionId === 'users') {
                document.getElementById('view-users').classList.remove('hidden');
            } else {
                loadToolEditor(sectionId);
            }
        }

        async function handleCreateUser(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-create-user');
            const msgContainer = document.getElementById('user-msg-container');
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-pass').value;
            const name = document.getElementById('new-user-name').value;
            const role = document.getElementById('new-user-role').value;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Creating...';
            msgContainer.innerHTML = '';

            try {
                const tempClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        persistSession: false,
                        autoRefreshToken: false,
                        detectSessionInUrl: false
                    }
                });

                const { data, error } = await tempClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: { full_name: name, role: role }
                    }
                });

                if (error) throw error;

                if (data.user) {
                    if (role === 'admin') {
                        await sbClient
                            .from('profiles')
                            .update({ role: 'admin' })
                            .eq('id', data.user.id);
                    }

                    msgContainer.innerHTML = `
                        <div class="rounded-md bg-green-50 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-check-circle text-green-400"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-green-800">User Created Successfully</h3>
                                    <div class="mt-2 text-sm text-green-700">
                                        <p>User <strong>${email}</strong> has been created with role <strong>${role}</strong>.</p>
                                    </div>
                                </div>
                            </div>
                        </div>`;

                    document.getElementById('createUserForm').reset();
                }

            } catch (err) {
                console.error("Create User Error:", err);
                msgContainer.innerHTML = `
                    <div class="rounded-md bg-red-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-times-circle text-red-400"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Creation Failed</h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <p>${err.message}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus mr-2"></i> Create Account';
            }
        }

        async function loadDashboardStats() {
            // Users count
            const { count } = await sbClient.from('profiles').select('*', { count: 'exact', head: true });
            document.getElementById('stat-users').innerText = count || 0;

            // Configs count
            const { count: confCount } = await sbClient.from('global_config').select('*', { count: 'exact', head: true });
            document.getElementById('stat-configs').innerText = confCount || 0;

            // Activity Log (Mock based on updated_at)
            const { data: activity } = await sbClient
                .from('global_config')
                .select('key, updated_at')
                .order('updated_at', { ascending: false })
                .limit(5);

            const list = document.getElementById('activity-list');
            list.innerHTML = '';
            if (activity && activity.length > 0) {
                activity.forEach(item => {
                    list.innerHTML += `
                        <li class="px-6 py-4 flex items-center justify-between hover:bg-gray-50">
                            <div>
                                <p class="text-sm font-medium text-indigo-600">${item.key}</p>
                                <p class="text-xs text-gray-500">Configuration updated</p>
                            </div>
                            <span class="text-xs text-gray-400">${new Date(item.updated_at).toLocaleString()}</span>
                        </li>
                    `;
                });
            } else {
                list.innerHTML = '<li class="px-6 py-4 text-center text-gray-500 text-sm">No recent activity.</li>';
            }
        }

        async function loadToolEditor(toolId) {
            const tool = TOOL_MAP[toolId];
            if (!tool) return;

            document.getElementById('view-tool-editor').classList.remove('hidden');
            document.getElementById('editor-title').innerText = tool.name;
            document.getElementById('editor-subtitle').innerText = tool.desc;
            document.getElementById('config-key-display').innerText = `Key: ${tool.key}`;
            document.getElementById('json-editor').value = 'Loading...';
            document.getElementById('save-status').classList.add('hidden');

            currentConfigKey = tool.key;

            // Fetch Data
            const { data, error } = await sbClient
                .from('global_config')
                .select('value')
                .eq('key', tool.key)
                .single();

            // MERGE Logic: Ensure new fields from template exist in fetched data
            const defaults = TEMPLATES[tool.key] || {};
            let configData = defaults;

            if (data && data.value) {
                // Merge: defaults first, then overwrite with DB data.
                // But we want to ensure keys from defaults exist if missing in DB.
                // Simple spread might lose nested 'features' if we aren't careful,
                // but here we just want to ensure root keys exist.
                configData = { ...defaults, ...data.value };

                // Ensure features object is also merged if it exists
                if (defaults.features && data.value.features) {
                    configData.features = { ...defaults.features, ...data.value.features };
                }
            }

            document.getElementById('json-editor').value = JSON.stringify(configData, null, 2);

            // Default to Visual Mode
            setVisibleEditorMode('visual');
        }

        window.saveCurrentConfig = async function () {
            const editor = document.getElementById('json-editor');
            const status = document.getElementById('save-status');

            try {
                const json = JSON.parse(editor.value);

                const { error } = await sbClient
                    .from('global_config')
                    .upsert({
                        key: currentConfigKey,
                        value: json,
                        updated_at: new Date(),
                        updated_by: currentUser.id
                    });

                if (error) throw error;

                status.innerText = "Saved successfully!";
                status.classList.remove('hidden', 'text-red-600');
                status.classList.add('text-green-600');
                setTimeout(() => status.classList.add('hidden'), 3000);

            } catch (e) {
                status.innerText = "Error: " + e.message;
                status.classList.remove('hidden', 'text-green-600');
                status.classList.add('text-red-600');
            }
        }

        window.resetEditor = function () {
            if (confirm("Discard unsaved changes and reload?")) {
                loadToolEditor(Object.keys(TOOL_MAP).find(k => TOOL_MAP[k].key === currentConfigKey));
            }
        }

        init();
    </script>
</body>

</html>