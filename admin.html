<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Meril Ecosystem</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            900: '#134e4a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Outfit', sans-serif;
        }

        /* Smooth Transitions */
        .sidebar-link {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .sidebar-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 0%;
            width: 3px;
            background-color: #0d9488;
            /* brand-600 */
            border-radius: 0 4px 4px 0;
            transition: all 0.2s ease;
            opacity: 0;
        }

        .sidebar-active {
            background-color: #f0fdfa;
            /* brand-50 */
            color: #0f766e !important;
            /* brand-700 */
        }

        .sidebar-active::before {
            height: 70%;
            opacity: 1;
        }

        .sidebar-link:hover:not(.sidebar-active) {
            background-color: #fafafa;
            color: #111827;
        }

        /* Glassmorphism for content cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Animation */
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #0d9488;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #0d9488;
        }
    </style>
</head>

<body class="bg-gray-50/50 text-gray-800 h-screen flex overflow-hidden selection:bg-teal-100 selection:text-teal-900">

    <!-- Sidebar -->
    <aside
        class="w-72 bg-white border-r border-gray-100 flex flex-col z-20 shadow-[4px_0_24px_-12px_rgba(0,0,0,0.1)] transition-all duration-300">
        <!-- Logo Area -->
        <div class="h-20 flex items-center px-8 border-b border-gray-50/50">
            <img src="logo.png" alt="Meril Logo"
                class="w-10 h-10 object-contain mr-3 transform hover:scale-105 transition-transform duration-300">
            <div>
                <h1 class="text-xl font-bold text-gray-900 tracking-tight leading-none">Meril</h1>
                <span class="text-[10px] font-bold text-teal-600 uppercase tracking-[0.2em]">Admin Console</span>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-1 custom-scroll">

            <div class="mb-6">
                <p class="px-4 text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-2">Main</p>
                <a href="#" onclick="showSection('dashboard')" id="nav-dashboard"
                    class="sidebar-link sidebar-active flex items-center px-4 py-3 text-sm font-medium text-gray-600 rounded-xl">
                    <i class="fas fa-chart-pie w-6 opacity-80 text-center"></i>
                    <span class="ml-2">Dashboard</span>
                </a>
            </div>

            <div class="mb-6">
                <p class="px-4 text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-2">Validators</p>
                <a href="#" onclick="showSection('tool-cardio')" id="nav-tool-cardio"
                    class="sidebar-link flex items-center px-4 py-2.5 text-gray-600 text-sm font-medium rounded-xl mb-1">
                    <i class="fas fa-heartbeat w-6 opacity-80 text-center"></i> <span class="ml-2">Cardio</span>
                </a>
                <a href="#" onclick="showSection('tool-mdpl')" id="nav-tool-mdpl"
                    class="sidebar-link flex items-center px-4 py-2.5 text-gray-600 text-sm font-medium rounded-xl mb-1">
                    <i class="fas fa-file-medical w-6 opacity-80 text-center"></i> <span class="ml-2">MDPL</span>
                </a>
                <a href="#" onclick="showSection('tool-mhpl')" id="nav-tool-mhpl"
                    class="sidebar-link flex items-center px-4 py-2.5 text-gray-600 text-sm font-medium rounded-xl mb-1">
                    <i class="fas fa-hospital w-6 opacity-80 text-center"></i> <span class="ml-2">MHPL</span>
                </a>
                <a href="#" onclick="showSection('tool-mlsipl')" id="nav-tool-mlsipl"
                    class="sidebar-link flex items-center px-4 py-2.5 text-gray-600 text-sm font-medium rounded-xl mb-1">
                    <i class="fas fa-flask w-6 opacity-80 text-center"></i> <span class="ml-2">MLSIPL</span>
                </a>
            </div>

            <div class="mb-6">
                <p class="px-4 text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-2">Communication</p>
                <a href="#" onclick="showSection('tool-chat')" id="nav-tool-chat"
                    class="sidebar-link flex items-center px-4 py-2.5 text-gray-600 text-sm font-medium rounded-xl">
                    <i class="fas fa-comments w-6 opacity-80 text-center"></i> <span class="ml-2">Chat System</span>
                </a>
            </div>

            <div class="mb-6">
                <p class="px-4 text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-2">Users</p>
                <a href="#" onclick="showSection('users')" id="nav-users"
                    class="sidebar-link flex items-center px-4 py-2.5 text-gray-600 text-sm font-medium rounded-xl mb-1">
                    <i class="fas fa-user-plus w-6 opacity-80 text-center"></i> <span class="ml-2">Add New</span>
                </a>
                <a href="#" onclick="showSection('user-list')" id="nav-user-list"
                    class="sidebar-link flex items-center px-4 py-2.5 text-gray-600 text-sm font-medium rounded-xl">
                    <i class="fas fa-users w-6 opacity-80 text-center"></i> <span class="ml-2">Directory</span>
                </a>
                <a href="#" onclick="showSection('audit-logs')" id="nav-audit-logs"
                    class="sidebar-link flex items-center px-4 py-2.5 text-gray-600 text-sm font-medium rounded-xl mt-1">
                    <i class="fas fa-history w-6 opacity-80 text-center"></i> <span class="ml-2">Audit Logs</span>
                </a>
            </div>

            <div>
                <p class="px-4 text-[11px] font-bold text-gray-400 uppercase tracking-wider mb-2">Settings</p>
                <a href="#" onclick="showSection('settings')" id="nav-settings"
                    class="sidebar-link flex items-center px-4 py-2.5 text-gray-600 text-sm font-medium rounded-xl">
                    <i class="fas fa-sliders w-6 opacity-80 text-center"></i> <span class="ml-2">Global Config</span>
                </a>
            </div>
        </nav>

        <!-- User Profile (Bottom) -->
        <div class="p-4 border-t border-gray-100 bg-gray-50/30">
            <div class="flex items-center gap-3 mb-3 px-2">
                <div class="w-9 h-9 rounded-full bg-white border border-gray-200 flex items-center justify-center text-teal-700 font-bold text-xs shadow-sm"
                    id="admin-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="min-w-0 flex-1">
                    <p class="text-xs font-bold text-gray-900 truncate" id="admin-name">Loading...</p>
                    <p class="text-[10px] text-emerald-600 font-medium truncate flex items-center">
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full mr-1.5 animate-pulse"></span> Active Now
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <button onclick="window.location.href='index.html'"
                    class="flex items-center justify-center px-3 py-2 border border-gray-200 text-gray-600 bg-white hover:bg-gray-50 hover:text-gray-900 text-[11px] font-bold rounded-lg shadow-sm transition-all duration-200">
                    <i class="fas fa-home mr-1.5"></i> Home
                </button>
                <button onclick="handleLogout()"
                    class="flex items-center justify-center px-3 py-2 border border-red-100 text-red-600 bg-white hover:bg-red-50 text-[11px] font-bold rounded-lg shadow-sm transition-all duration-200">
                    <i class="fas fa-sign-out-alt mr-1.5"></i> Logout
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-[#fafafa] relative">

        <!-- Background Decor -->
        <div
            class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-teal-50/50 to-transparent pointer-events-none">
        </div>

        <!-- content container -->
        <div class="relative z-10 max-w-7xl mx-auto">

            <!-- Loading Overlay -->
            <div id="loading"
                class="fixed inset-0 bg-white/80 backdrop-blur-md z-50 flex flex-col items-center justify-center transition-opacity duration-300">
                <div class="relative">
                    <div class="w-16 h-16 border-4 border-teal-100 border-t-teal-500 rounded-full animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i class="fas fa-shield-alt text-teal-500 text-lg"></i>
                    </div>
                </div>
                <p class="mt-4 text-sm font-medium text-gray-500 animate-pulse">Authenticating Admin...</p>
            </div>

            <!-- Dashboard View -->
            <div id="view-dashboard" class="view-section px-8 py-8 fade-in-up">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 tracking-tight">Dashboard Overview</h2>
                        <p class="text-gray-500 mt-1 text-sm">Welcome back, here's what's happening today.</p>
                    </div>
                    <span
                        class="px-3 py-1 bg-white border border-gray-200 rounded-full text-xs font-medium text-gray-600 shadow-sm">
                        <i class="far fa-calendar mr-2"></i> <span id="current-date">Today</span>
                    </span>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Users Card -->
                    <div
                        class="bg-white rounded-2xl p-6 shadow-[0_2px_12px_-4px_rgba(0,0,0,0.08)] border border-gray-100 relative overflow-hidden group hover:shadow-[0_8px_24px_-6px_rgba(0,0,0,0.12)] transition-shadow duration-300">
                        <div
                            class="absolute top-0 right-0 w-32 h-32 bg-indigo-50 rounded-bl-full -mr-8 -mt-8 opacity-50 group-hover:scale-110 transition-transform duration-500">
                        </div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <div
                                    class="w-12 h-12 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl shadow-inner">
                                    <i class="fas fa-users"></i>
                                </div>
                                <span
                                    class="bg-indigo-50 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wide">Total
                                    Users</span>
                            </div>
                            <h3 class="text-4xl font-bold text-gray-900 mb-1" id="stat-users">-</h3>
                            <a href="#" onclick="showSection('user-list')"
                                class="text-sm text-indigo-600 hover:text-indigo-700 font-medium inline-flex items-center group-hover:translate-x-1 transition-transform">
                                Manage Users <i class="fas fa-arrow-right ml-1 text-xs"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Configs Card -->
                    <div
                        class="bg-white rounded-2xl p-6 shadow-[0_2px_12px_-4px_rgba(0,0,0,0.08)] border border-gray-100 relative overflow-hidden group hover:shadow-[0_8px_24px_-6px_rgba(0,0,0,0.12)] transition-shadow duration-300">
                        <div
                            class="absolute top-0 right-0 w-32 h-32 bg-teal-50 rounded-bl-full -mr-8 -mt-8 opacity-50 group-hover:scale-110 transition-transform duration-500">
                        </div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <div
                                    class="w-12 h-12 rounded-xl bg-teal-50 text-teal-600 flex items-center justify-center text-xl shadow-inner">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <span
                                    class="bg-teal-50 text-teal-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wide">Active
                                    Configs</span>
                            </div>
                            <h3 class="text-4xl font-bold text-gray-900 mb-1" id="stat-configs">-</h3>
                            <span class="text-sm text-gray-400">System modules active</span>
                        </div>
                    </div>

                    <!-- System Status Card -->
                    <div
                        class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 shadow-lg text-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-white/5 rounded-full blur-3xl -mr-10 -mt-10">
                        </div>
                        <div class="relative z-10 h-full flex flex-col justify-between">
                            <div class="flex justify-between items-center mb-4">
                                <div
                                    class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center text-xl backdrop-blur-sm">
                                    <i class="fas fa-server"></i>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span
                                        class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse shadow-[0_0_8px_rgba(52,211,153,0.6)]"></span>
                                    <span
                                        class="text-xs font-bold text-emerald-400 uppercase tracking-widest">Online</span>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium text-gray-200">System Health</h3>
                                <p class="text-3xl font-bold mt-1">100% <span
                                        class="text-sm font-normal text-gray-400">Operational</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-50 flex items-center justify-between">
                        <h3 class="font-bold text-gray-800">Recent Configuration Changes</h3>
                        <button class="text-gray-400 hover:text-teal-600 transition-colors"><i
                                class="fas fa-ellipsis-h"></i></button>
                    </div>
                    <ul id="activity-list" class="divide-y divide-gray-50">
                        <li class="px-6 py-8 text-center text-gray-400 text-sm italic">
                            <i class="fas fa-circle-notch fa-spin mr-2"></i> Loading activity log...
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Create User View -->
            <div id="view-users" class="view-section px-8 py-8 hidden fade-in-up">
                <div class="max-w-2xl mx-auto">
                    <div class="mb-8 text-center">
                        <div
                            class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600 text-2xl shadow-sm">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-900">Create New Account</h2>
                        <p class="text-gray-500 mt-2">Add a new user to the ecosystem. They'll receive an email to set
                            up access.</p>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                        <form id="createUserForm" onsubmit="handleCreateUser(event)" class="p-8 space-y-6">

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Full
                                        Name</label>
                                    <input type="text" id="new-user-name" required
                                        class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none"
                                        placeholder="e.g. Jane Doe">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Role
                                        Access</label>
                                    <select id="new-user-role"
                                        class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none">
                                        <option value="user">Standard User</option>
                                        <option value="admin">Administrator</option>
                                    </select>
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Email
                                    Address</label>
                                <div class="relative">
                                    <i
                                        class="fas fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="email" id="new-user-email" required placeholder="user@merillife.com"
                                        class="w-full pl-10 pr-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none">
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Password</label>
                                <div class="relative">
                                    <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="password" id="new-user-pass" required minlength="6"
                                        placeholder="••••••••"
                                        class="w-full pl-10 pr-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none">
                                </div>
                                <p class="text-xs text-gray-400 text-right">Min 6 characters</p>
                            </div>

                            <div class="pt-4 flex items-center justify-end space-x-4">
                                <button type="button" onclick="document.getElementById('createUserForm').reset()"
                                    class="px-6 py-2.5 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-800 hover:bg-gray-50 transition-colors">Reset</button>
                                <button type="submit" id="btn-create-user"
                                    class="px-8 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold shadow-lg shadow-indigo-600/30 transform hover:-translate-y-0.5 transition-all w-full md:w-auto">
                                    Create Account
                                </button>
                            </div>

                        </form>
                    </div>

                    <div id="user-msg-container" class="mt-6"></div>
                </div>
            </div>

            <!-- User List View -->
            <div id="view-user-list" class="view-section px-8 py-8 hidden fade-in-up">
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">User Directory</h2>
                        <p class="text-gray-500 mt-1">View and manage all registered users.</p>
                    </div>
                    <button onclick="loadUsers()"
                        class="px-4 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg text-sm font-bold shadow-sm hover:border-gray-300 hover:text-gray-800 transition-all flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh List
                    </button>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50/50 border-b border-gray-100">
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">
                                        User Profile</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">
                                        Role</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">
                                        Last Activity</th>
                                    <th
                                        class="px-6 py-4 text-right text-xs font-bold text-gray-400 uppercase tracking-wider">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="divide-y divide-gray-50">
                                <tr>
                                    <td colspan="4" class="px-6 py-12 text-center">
                                        <div class="flex flex-col items-center justify-center text-gray-400">
                                            <i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-teal-500"></i>
                                            <span class="text-sm">Fetching user data...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tool Editor View -->
            <div id="view-tool-editor" class="view-section px-8 py-8 hidden fade-in-up">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span
                                class="px-2 py-0.5 rounded text-[10px] font-bold bg-teal-50 text-teal-700 uppercase tracking-wide">Configuring</span>
                            <span class="text-xs font-mono text-gray-400" id="config-key-display">key_name</span>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-900" id="editor-title">Tool Name</h2>
                        <p class="text-gray-500" id="editor-subtitle">Manage configuration settings.</p>
                    </div>

                    <div class="flex items-center gap-3 bg-white p-1 rounded-xl border border-gray-200 shadow-sm">
                        <button onclick="setVisibleEditorMode('visual')" id="btn-mode-visual"
                            class="px-4 py-2 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2">
                            <i class="fas fa-sliders"></i> Visual
                        </button>
                        <button onclick="setVisibleEditorMode('code')" id="btn-mode-code"
                            class="px-4 py-2 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2">
                            <i class="fas fa-code"></i> JSON
                        </button>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="sticky top-4 z-20 bg-white/90 backdrop-blur-md rounded-xl border border-gray-200 shadow-lg p-3 mb-6 flex justify-between items-center transform transition-all"
                    id="action-bar">
                    <div class="flex items-center gap-2 text-sm text-gray-500 px-2">
                        <i class="fas fa-info-circle text-teal-500"></i>
                        <span>Make changes below</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="resetEditor()"
                            class="px-4 py-2 rounded-lg text-xs font-bold text-gray-600 hover:bg-gray-100 transition-colors">Discard</button>
                        <button onclick="loadTemplate()"
                            class="px-4 py-2 rounded-lg text-xs font-bold text-teal-600 bg-teal-50 hover:bg-teal-100 transition-colors">Load
                            Template</button>
                        <button onclick="saveCurrentConfig()"
                            class="px-6 py-2 rounded-lg text-xs font-bold text-white bg-gray-900 hover:bg-black shadow-md transition-all flex items-center gap-2">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>

                <!-- Visual Editor -->
                <div id="visual-editor-container"
                    class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 hidden">
                    <div id="visual-controls" class="space-y-6"></div>
                </div>

                <!-- JSON Editor -->
                <div id="json-editor-container" class="bg-[#1e1e1e] rounded-2xl shadow-2xl overflow-hidden hidden">
                    <div class="px-6 py-3 bg-[#252526] flex justify-between items-center border-b border-[#333]">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest"><i
                                class="fas fa-code mr-2"></i>Source</span>
                        <span class="text-[10px] text-gray-500">JSON</span>
                    </div>
                    <textarea id="json-editor"
                        class="w-full h-[600px] p-6 bg-[#1e1e1e] text-blue-200 font-mono text-sm border-0 focus:ring-0 resize-none outline-none leading-relaxed"
                        spellcheck="false"></textarea>
                </div>

                <div class="mt-4 flex justify-end">
                    <div id="save-status"
                        class="hidden px-4 py-2 bg-green-50 text-green-700 text-sm font-bold rounded-lg items-center gap-2 animate-bounce">
                        <i class="fas fa-check-circle"></i> Saved Successfully
                    </div>
                </div>
            </div>

        </div>

        <!-- Edit User Modal -->
        <div id="modal-edit-user" class="fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="absolute inset-0 bg-gray-900/50 backdrop-blur-sm" onclick="closeEditUser()"></div>
            <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden fade-in-up">
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <h3 class="text-lg font-bold text-gray-900">Edit User Details</h3>
                    <button onclick="closeEditUser()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="editUserForm" onsubmit="handleUpdateUser(event)" class="p-6 space-y-4">
                    <input type="hidden" id="edit-user-id">

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Full Name</label>
                        <input type="text" id="edit-user-name" required
                            class="w-full px-4 py-2.5 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none">
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Role</label>
                        <select id="edit-user-role"
                            class="w-full px-4 py-2.5 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none">
                            <option value="user">Standard User</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>

                    <div class="pt-4 border-t border-gray-100">
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-2">Reset
                            Password <span class="text-gray-400 font-normal normal-case">(Optional)</span></label>
                        <div class="relative">
                            <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="password" id="edit-user-pass" minlength="6" placeholder="New password"
                                class="w-full pl-10 pr-4 py-2.5 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all outline-none">
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">Leave blank to keep current password.</p>
                    </div>

                    <div id="edit-msg-container" class="text-sm"></div>

                    <div class="pt-2 flex items-center justify-end gap-3">
                        <button type="button" onclick="closeEditUser()"
                            class="px-4 py-2 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-50 transition-colors">Cancel</button>
                        <button type="submit" id="btn-update-user"
                            class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold shadow-md transition-all">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
        </div>

        <!-- Audit Logs View -->
        <div id="view-audit-logs" class="view-section hidden px-8 py-8 max-w-7xl mx-auto">
            <div class="mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">System Audit Logs</h1>
                    <p class="text-gray-500 mt-1">Track all system changes and administrative actions.</p>
                </div>
                <button onclick="loadAuditLogs()"
                    class="text-indigo-600 hover:text-indigo-800 transition-colors flex items-center gap-2 text-sm font-bold">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr
                                class="bg-gray-50 border-b border-gray-100 text-xs uppercase tracking-wider text-gray-500 font-bold">
                                <th class="px-6 py-4">Actor</th>
                                <th class="px-6 py-4">Action</th>
                                <th class="px-6 py-4">Target</th>
                                <th class="px-6 py-4">Details</th>
                                <th class="px-6 py-4 text-right">Time</th>
                            </tr>
                        </thead>
                        <tbody id="audit-table-body" class="text-sm divide-y divide-gray-100">
                            <!-- Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- JS Logic -->
    <script>
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

        const SUPABASE_URL = 'https://etdqyrkihsbritcikpbi.supabase.co';
        // NOTE: In production, do not expose keys. This is a demo.
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0ZHF5cmtpaHNicml0Y2lrcGJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTMxNzksImV4cCI6MjA4NjAyOTE3OX0.gNVhroMQpc_2Yl3p8UyjdalTqzeUHvLgjcu-XxBWI1I';

        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        let currentConfigKey = null;

        // Tool Config
        const TOOL_MAP = {
            'tool-cardio': { key: 'cardio_settings', name: 'Cardio Validator', desc: 'Heart rate analysis configs' },
            'tool-mdpl': { key: 'mdpl_settings', name: 'MDPL Validator', desc: 'MDPL compliance rules' },
            'tool-mhpl': { key: 'mhpl_settings', name: 'MHPL Validator', desc: 'Hospital data settings' },
            'tool-mlsipl': { key: 'mlsipl_settings', name: 'MLSIPL Validator', desc: 'System integration points' },
            'tool-chat': { key: 'chat_settings', name: 'Chat System', desc: 'Messaging & retention policies' },
            'settings': { key: 'global_settings', name: 'Global Settings', desc: 'System-wide variables' }
        };

        const TEMPLATES = {
            'cardio_settings': {
                "enabled": true,
                "features": { "allow_export": true },
                "material_master_csv": "",
                "customer_master_csv": ""
            },
            'mdpl_settings': {
                "enabled": true,
                "features": { "allow_export": true },
                "material_master_csv": "",
                "customer_master_csv": ""
            },
            'mhpl_settings': {
                "enabled": true,
                "features": { "allow_export": true },
                "material_master_csv": "",
                "customer_master_csv": ""
            },
            'mlsipl_settings': {
                "enabled": true,
                "version": "v1",
                "features": { "allow_export": true },
                "material_master_csv": "",
                "customer_master_csv": ""
            },
            'chat_settings': { "enabled": true, "retention_days": 30, "features": { "allow_file_sharing": true } },
            'global_settings': { "system_name": "Meril Ecosystem", "maintenance_mode": false }
        };

        // --- INIT ---
        async function init() {
            try {
                const { data: { user } } = await sbClient.auth.getUser();
                if (!user) throw new Error("No user");

                const { data: profile } = await sbClient.from('profiles').select('role, username').eq('id', user.id).single();
                if (!profile || profile.role !== 'admin') {
                    window.location.href = 'index.html';
                    return;
                }

                currentUser = user;
                document.getElementById('admin-name').innerText = profile.username || user.email.split('@')[0];
                document.getElementById('loading').classList.add('opacity-0', 'pointer-events-none');

                loadDashboardStats();

            } catch (e) {
                console.error(e);
                window.location.href = 'index.html';
            }
        }

        // --- NAVIGATION ---
        window.showSection = function (id) {
            // Updated Sidebar States
            document.querySelectorAll('.sidebar-link').forEach(el => {
                el.classList.remove('sidebar-active', 'bg-teal-50', 'text-teal-700');
                el.classList.add('text-gray-600');
            });

            const link = document.getElementById(`nav-${id}`);
            if (link) {
                link.classList.add('sidebar-active');
                link.classList.remove('text-gray-600');
            }

            // Hide Views
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('fade-in-up');
                el.classList.add('hidden');
            });

            // Show Target
            let viewId = 'view-tool-editor';
            if (id === 'users') viewId = 'view-users';
            else if (id === 'dashboard') viewId = 'view-dashboard';
            else if (id === 'user-list') viewId = 'view-user-list';
            else if (id === 'audit-logs') viewId = 'view-audit-logs';

            const view = document.getElementById(viewId);

            view.classList.remove('hidden');
            // Trigger Reflow for animation
            void view.offsetWidth;
            view.classList.add('fade-in-up');

            if (id === 'dashboard') loadDashboardStats();
            else if (id === 'user-list') loadUsers();
            else if (id === 'audit-logs') loadAuditLogs();
            else if (id !== 'users') loadToolEditor(id);
        };

        // --- DASHBOARD STATS ---
        async function loadDashboardStats() {
            const { count: uCount } = await sbClient.from('profiles').select('*', { count: 'exact', head: true });
            document.getElementById('stat-users').innerText = uCount || 0;

            const { count: cCount } = await sbClient.from('global_config').select('*', { count: 'exact', head: true });
            document.getElementById('stat-configs').innerText = cCount || 0;

            const { data: logs } = await sbClient.from('global_config').select('key, updated_at').order('updated_at', { ascending: false }).limit(5);

            const list = document.getElementById('activity-list');
            list.innerHTML = '';
            if (logs && logs.length) {
                logs.forEach(l => {
                    list.innerHTML += `
                        <li class="px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors cursor-default group">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-teal-50 text-teal-600 flex items-center justify-center text-xs group-hover:bg-teal-100 transition-colors">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm font-bold text-gray-700">${l.key}</span>
                                    <span class="text-[10px] text-gray-400 uppercase tracking-wider">Modified</span>
                                </div>
                            </div>
                            <span class="text-xs font-mono text-gray-400">${new Date(l.updated_at).toLocaleDateString()}</span>
                        </li>`;
                });
            } else {
                list.innerHTML = `<li class="px-6 py-8 text-center text-gray-400 text-sm italic">No recent activity found.</li>`;
            }
        }

        // --- USER MANAGEMENT ---
        async function handleCreateUser(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-create-user');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing';
            btn.disabled = true;

            const name = document.getElementById('new-user-name').value;
            const role = document.getElementById('new-user-role').value;
            const email = document.getElementById('new-user-email').value;
            const pass = document.getElementById('new-user-pass').value;
            const msg = document.getElementById('user-msg-container');

            try {
                // Secondary Client for Auth creation
                const tempClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });
                const { data, error } = await tempClient.auth.signUp({
                    email, password: pass, options: { data: { full_name: name, role: role } }
                });

                if (error) throw error;
                if (data.user && role === 'admin') {
                    await sbClient.from('profiles').update({ role: 'admin' }).eq('id', data.user.id);
                }

                msg.innerHTML = `<div class="p-4 rounded-xl bg-green-50 border border-green-100 text-green-700 flex items-center gap-3"><i class="fas fa-check-circle text-xl"></i><div><p class="font-bold">Success!</p><p class="text-xs">User created.</p></div></div>`;
                document.getElementById('createUserForm').reset();
                setTimeout(() => msg.innerHTML = '', 4000);

            } catch (err) {
                msg.innerHTML = `<div class="p-4 rounded-xl bg-red-50 border border-red-100 text-red-700 flex items-center gap-3"><i class="fas fa-exclamation-circle text-xl"></i><div><p class="font-bold">Error</p><p class="text-xs">${err.message}</p></div></div>`;
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-gray-400"><i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-teal-500"></i><br>Loading...</td></tr>';

            try {
                const { data: users, error } = await sbClient.from('profiles').select('*').order('email');
                if (error) throw error;

                if (!users.length) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-gray-400">No users found.</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(u => `
                    <tr class="hover:bg-gray-50/80 transition-colors group">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-100 to-indigo-50 text-indigo-600 font-bold flex items-center justify-center text-sm shadow-sm">
                                    ${(u.full_name || u.username || u.email || 'U').charAt(0).toUpperCase()}
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-bold text-gray-900">${u.full_name || u.username || 'Unknown'}</div>
                                    <div class="text-xs text-gray-400 font-mono">${u.email || u.id}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${u.role === 'admin' ? 'bg-purple-50 text-purple-700 border border-purple-100' : 'bg-green-50 text-green-700 border border-green-100'}">
                                ${u.role || 'user'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-xs font-mono text-gray-400">
                            ${u.updated_at ? new Date(u.updated_at).toLocaleDateString() : '-'}
                        </td>
                        <td class="px-6 py-4 text-right flex justify-end gap-2">
                            <button onclick="openEditUser('${u.id}', '${(u.full_name || '').replace(/'/g, "\\'")}', '${u.role || 'user'}')" class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:bg-indigo-50 hover:text-indigo-600 transition-all" title="Edit User">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteUser('${u.id}')" class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:bg-red-50 hover:text-red-600 transition-all" title="Delete User">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-12 text-center text-red-500">Error: ${err.message}</td></tr>`;
            }
        }

        async function deleteUser(id) {
            if (!confirm("DELETE USER?\nThis cannot be undone.")) return;
            await sbClient.from('profiles').delete().eq('id', id);
            loadUsers();
        }

        // --- EDIT USER LOGIC ---
        function openEditUser(id, name, role) {
            document.getElementById('edit-user-id').value = id;
            document.getElementById('edit-user-name').value = name;
            document.getElementById('edit-user-role').value = role;
            document.getElementById('edit-user-pass').value = '';
            document.getElementById('edit-msg-container').innerText = '';
            document.getElementById('modal-edit-user').classList.remove('hidden');
        }

        function closeEditUser() {
            document.getElementById('modal-edit-user').classList.add('hidden');
        }

        async function handleUpdateUser(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-update-user');
            const id = document.getElementById('edit-user-id').value;
            const name = document.getElementById('edit-user-name').value;
            const role = document.getElementById('edit-user-role').value;
            const pass = document.getElementById('edit-user-pass').value;
            const msg = document.getElementById('edit-msg-container');

            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Saving...';
            btn.disabled = true;
            msg.innerHTML = '';

            try {
                // 1. Update Profile (Name & Role)
                const { error: profileError } = await sbClient
                    .from('profiles')
                    .update({ full_name: name, role: role, updated_at: new Date() })
                    .eq('id', id);

                if (profileError) throw profileError;

                // 2. Reset Password (if provided)
                if (pass && pass.length > 0) {
                    const { error: passError } = await sbClient.rpc('admin_reset_user_password', {
                        target_user_id: id,
                        new_password: pass
                    });

                    if (passError) throw new Error('Password Reset Failed: ' + passError.message);
                }

                msg.innerHTML = `<span class="text-green-600 font-bold"><i class="fas fa-check-circle mr-1"></i> User updated successfully!</span>`;
                setTimeout(() => {
                    closeEditUser();
                    loadUsers();
                }, 1500);

            } catch (err) {
                console.error(err);
                msg.innerHTML = `<span class="text-red-600 font-bold"><i class="fas fa-exclamation-circle mr-1"></i> ${err.message}</span>`;
            } finally {
                btn.innerHTML = 'Save Changes';
                btn.disabled = false;
            }
        }

        // --- AUDIT LOGS LOGIC ---
        async function loadAuditLogs() {
            const tbody = document.getElementById('audit-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-400"><i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-indigo-500"></i><br>Loading logs...</td></tr>';

            try {
                const { data: logs, error } = await sbClient
                    .from('audit_logs')
                    .select(`
                        *,
                        actor:profiles!actor_id(full_name, email)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                if (!logs.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-400">No audit logs found.</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(l => `
                    <tr class="hover:bg-gray-50/50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 text-xs font-bold mr-3">
                                     ${(l.actor?.full_name || 'S').charAt(0)}
                                </div>
                                <div>
                                    <div class="font-bold text-gray-900">${l.actor?.full_name || 'System'}</div>
                                    <div class="text-[10px] text-gray-400">${l.actor?.email || 'System Action'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider 
                                ${l.action.includes('DELETE') ? 'bg-red-50 text-red-600' :
                        (l.action.includes('UPDATE') ? 'bg-amber-50 text-amber-600' : 'bg-blue-50 text-blue-600')}">
                                ${l.action}
                            </span>
                        </td>
                        <td class="px-6 py-4 font-mono text-xs text-gray-600">
                            ${l.target_entity} / <span class="text-gray-900 font-bold">${l.target_id || '-'}</span>
                        </td>
                        <td class="px-6 py-4 text-xs text-gray-500 max-w-xs truncate" title='${JSON.stringify(l.metadata)}'>
                            ${JSON.stringify(l.metadata)}
                        </td>
                        <td class="px-6 py-4 text-right text-xs text-gray-400 whitespace-nowrap">
                            ${new Date(l.created_at).toLocaleString()}
                        </td>
                    </tr>
                `).join('');

            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-red-500">Error: ${err.message}</td></tr>`;
            }
        }

        // --- EDITOR LOGIC ---
        function setVisibleEditorMode(mode) {
            const vBtn = document.getElementById('btn-mode-visual');
            const cBtn = document.getElementById('btn-mode-code');
            const vCon = document.getElementById('visual-editor-container');
            const jCon = document.getElementById('json-editor-container');

            if (mode === 'visual') {
                vBtn.classList.replace('text-gray-600', 'bg-gray-900');
                vBtn.classList.replace('text-gray-600', 'text-white'); // Fix active style
                vBtn.className = "px-4 py-2 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2 bg-gray-900 text-white shadow-lg shadow-gray-900/20";

                cBtn.className = "px-4 py-2 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2 text-gray-500 hover:bg-gray-50";

                try {
                    const json = JSON.parse(document.getElementById('json-editor').value);
                    renderVisualEditor(json);
                    vCon.classList.remove('hidden');
                    jCon.classList.add('hidden');
                } catch (e) { alert("JSON Error"); }
            } else {
                cBtn.className = "px-4 py-2 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2 bg-gray-900 text-white shadow-lg shadow-gray-900/20";
                vBtn.className = "px-4 py-2 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2 text-gray-500 hover:bg-gray-50";

                vCon.classList.add('hidden');
                jCon.classList.remove('hidden');
            }
        }

        async function loadToolEditor(id) {
            const tool = TOOL_MAP[id];
            currentConfigKey = tool.key;

            document.getElementById('editor-title').innerText = tool.name;
            document.getElementById('editor-subtitle').innerText = tool.desc;
            document.getElementById('config-key-display').innerText = tool.key;

            const { data } = await sbClient.from('global_config').select('value').eq('key', tool.key).single();
            const defaults = TEMPLATES[tool.key] || {};
            const config = { ...defaults, ...(data?.value || {}) };

            if (defaults.features && data?.value?.features) {
                config.features = { ...defaults.features, ...data.value.features };
            }

            document.getElementById('json-editor').value = JSON.stringify(config, null, 2);
            setVisibleEditorMode('visual');
        }

        function renderVisualEditor(config) {
            const con = document.getElementById('visual-controls');
            con.innerHTML = '';

            // 1. Feature Flags
            if (config.features) {
                const grp = document.createElement('div');
                grp.className = "mb-8 p-6 bg-gray-50 rounded-2xl border border-gray-100";
                grp.innerHTML = '<h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Feature Flags</h4>';

                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 md:grid-cols-2 gap-4";

                Object.keys(config.features).forEach(k => {
                    grid.appendChild(createToggle(k, config.features[k], (v) => {
                        config.features[k] = v;
                        updateJson(config);
                    }));
                });
                grp.appendChild(grid);
                con.appendChild(grp);
            }

            // 2. Master Data (CSV text fields)
            const csvKeys = Object.keys(config).filter(k => k.endsWith('_csv'));
            if (csvKeys.length > 0) {
                const grp = document.createElement('div');
                grp.className = "mb-8 p-6 bg-blue-50/50 rounded-2xl border border-blue-100";
                grp.innerHTML = '<h4 class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-4">Master Data Management</h4>';

                csvKeys.forEach(k => {
                    grp.appendChild(createCsvEditor(k, config[k], (v) => {
                        config[k] = v;
                        updateJson(config);
                    }));
                });
                con.appendChild(grp);
            }

            // 3. General Settings (Rest)
            const otherKeys = Object.keys(config).filter(k => k !== 'features' && !k.endsWith('_csv'));
            if (otherKeys.length > 0) {
                const grp = document.createElement('div');
                grp.className = "mb-8 p-6 bg-white rounded-2xl border border-gray-100";
                grp.innerHTML = '<h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">General Settings</h4>';

                otherKeys.forEach(k => {
                    if (typeof config[k] === 'boolean') {
                        grp.appendChild(createToggle(k, config[k], (v) => { config[k] = v; updateJson(config); }));
                    } else if (typeof config[k] === 'string' || typeof config[k] === 'number') {
                        grp.appendChild(createInput(k, config[k], (v) => { config[k] = v; updateJson(config); }));
                    }
                });
                con.appendChild(grp);
            }
        }

        function createToggle(key, val, cb) {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between p-4 bg-white rounded-xl border border-gray-100 shadow-sm hover:border-teal-200 transition-all";
            div.innerHTML = `
                <div>
                   <div class="text-sm font-bold text-gray-800 capitalize">${key.replace(/_/g, ' ')}</div>
                   <div class="text-[10px] font-mono text-gray-400">${key}</div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer toggle-checkbox" ${val ? 'checked' : ''}>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600 toggle-label"></div>
                </label>`;
            div.querySelector('input').onchange = (e) => cb(e.target.checked);
            return div;
        }

        function createInput(key, val, cb) {
            const div = document.createElement('div');
            div.className = "mb-4";
            const isNum = typeof val === 'number';
            div.innerHTML = `
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">${key.replace(/_/g, ' ')}</label>
                <input type="${isNum ? 'number' : 'text'}" value="${val}" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-teal-500 focus:ring-4 focus:ring-teal-500/10 transition-all outline-none font-medium text-gray-700">`;
            div.querySelector('input').oninput = (e) => cb(isNum ? parseFloat(e.target.value) : e.target.value);
            return div;
        }

        function createCsvEditor(key, val, cb) {
            const div = document.createElement('div');
            div.className = "mb-6 bg-white p-4 rounded-xl border border-blue-100 shadow-sm";
            const rowCount = val ? val.split('\n').length : 0;

            div.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <label class="block text-sm font-bold text-gray-800 uppercase tracking-wider">${key.replace(/_/g, ' ')}</label>
                        <div class="text-[10px] text-gray-400 font-mono">Current Data: ${rowCount} rows</div>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="downloadAdminTemplate('${key}')" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition-colors" title="Download Standard Template">
                            <i class="fas fa-download"></i> Template
                         </button>
                         <input type="file" id="upload-${key}" accept=".csv" class="hidden" />
                         <label for="upload-${key}" class="cursor-pointer bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition-colors">
                            <i class="fas fa-file-upload"></i> Upload CSV
                         </label>
                    </div>
                </div>
                <textarea class="w-full h-32 px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 font-mono text-xs text-gray-600 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none resize-y"
                    placeholder="Paste CSV data here or upload a file...">${val || ''}</textarea>
            `;

            const textarea = div.querySelector('textarea');
            const fileInput = div.querySelector('input[type="file"]');

            textarea.oninput = (e) => cb(e.target.value);

            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const text = evt.target.result;
                    textarea.value = text;
                    cb(text); // Update State
                    // Update Row Count Display
                    div.querySelector('.text-gray-400').innerText = `Current Data: ${text.split('\n').length} rows`;
                };
                reader.readAsText(file);
            };

            return div;
        }

        function updateJson(config) {
            document.getElementById('json-editor').value = JSON.stringify(config, null, 2);
        }

        async function saveCurrentConfig() {
            const status = document.getElementById('save-status');
            try {
                const json = JSON.parse(document.getElementById('json-editor').value);
                const { error } = await sbClient.from('global_config').upsert({
                    key: currentConfigKey, value: json, updated_at: new Date(), updated_by: currentUser.id
                });
                if (error) throw error;
                status.classList.remove('hidden');
                setTimeout(() => status.classList.add('hidden'), 3000);
            } catch (e) { alert("Save Failed: " + e.message); }
        }

        async function handleLogout() {
            await sbClient.auth.signOut();
            window.location.href = 'index.html';
        }

        // --- ADMIN TEMPLATE DOWNLOAD ---
        function downloadAdminTemplate(key) {
            let content = "";
            let filename = "";

            if (key.includes('material')) {
                content = "Material Code,Description\nMAT001,Sample Description\nMAT002,Another Item";
                filename = "Material_Master_Template.csv";
            } else if (key.includes('customer')) {
                content = "Customer Code,Customer Name\nC001,Sample Customer Pvt Ltd\nC002,Another Client";
                filename = "Customer_Master_Template.csv";
            }

            if (!content) {
                alert("No template available for this field.");
                return;
            }

            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        init();
    </script>
</body>

</html>