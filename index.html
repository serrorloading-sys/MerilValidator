<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meril-V Stock Validator | Entity Selection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script>
        // Protect Route
        document.addEventListener('DOMContentLoaded', requireAuth);
    </script>

    <style>
        body {
            /* Fallback */
            background-color: #ffffff;
            background-image: url('bg-01.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            font-family: 'Segoe UI', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Dark Overlay */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            /* Darkens slightly for text contrast but keeps image clear */
            /* backdrop-filter: blur(3px); REMOVED for visibility */
            z-index: -1;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .entity-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.6));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            border-radius: 16px;
        }

        .entity-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.9);
            z-index: 10;
        }

        /* Shine Effect */
        .entity-card::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            transition: 0.5s;
            transform: skewX(-15deg);
        }

        .entity-card:hover::after {
            left: 100%;
        }

        .animate-fade-up {
            animation: fadeUp 0.8s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .icon-circle {
            transition: all 0.3s ease;
        }

        .entity-card:hover .icon-circle {
            transform: scale(1.1) rotate(5deg);
        }

        .bg-ortho {
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            color: #0284c7;
        }

        .bg-cardio {
            background: linear-gradient(135deg, #ffe4e6, #fecdd3);
            color: #e11d48;
        }

        .bg-diag {
            background: linear-gradient(135deg, #f0fdf4, #bbf7d0);
            color: #16a34a;
        }

        .bg-mhpl {
            background: linear-gradient(135deg, #f5f3ff, #ddd6fe);
            color: #7c3aed;
        }
    </style>
</head>

<body class="p-4">

    <div class="w-full max-w-6xl mx-auto text-center">

        <!-- Header -->
        <div class="mb-6 animate-fade-up" style="animation-delay: 0.1s;">
            <!-- You can add logo.png here if needed, for now just text -->
            <img src="logo.png" alt="Meril Logo"
                class="h-14 mx-auto mb-3 drop-shadow-lg object-contain bg-white/60 p-2 rounded-lg backdrop-blur-sm">

            <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-1 tracking-tight drop-shadow-md">
                Welcome to <span class="text-white">Meril-</span><span class="text-yellow-400 font-bold">V</span> Stock
                Validator
            </h1>
            <p class="text-blue-100 text-sm md:text-base font-medium drop-shadow">
                Select Your Entity to Begin Validation
            </p>
        </div>

        <!-- Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 px-4 pb-6">

            <!-- Card 1: MHPL Ortho -->
            <a href="MHPL-Validator.html" onclick="handleToolClick(event, 'mhpl_settings', 'MHPL-Validator.html')"
                class="block text-left decoration-none animate-fade-up" style="animation-delay: 0.2s;">
                <div class="entity-card h-64 flex flex-col p-5 group cursor-pointer hover:bg-white/90">
                    <div
                        class="w-14 h-14 rounded-2xl bg-mhpl flex items-center justify-center mb-4 shadow-sm icon-circle group-hover:shadow-md">
                        <i class="fas fa-bone text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-xl font-bold text-gray-800 mb-1 group-hover:text-purple-700 transition-colors">
                            MHPL</h2>
                        <h3 class="text-xs font-bold text-purple-600 uppercase tracking-wider mb-2">Orthopedics</h3>
                        <p class="text-xs text-gray-500 leading-relaxed">
                            Meril Healthcare Private Limited. <br>
                            Validation for implants, instruments, and trauma inventory.
                        </p>
                    </div>
                    <div
                        class="mt-3 flex items-center text-purple-600 text-xs font-bold group-hover:translate-x-1 transition-transform">
                        Launch Tool <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </div>
            </a>

            <!-- Card 2: MLSIPL Ortho -->
            <a href="MLSIPL-Validator.html" onclick="handleToolClick(event, 'mlsipl_settings', 'MLSIPL-Validator.html')"
                class="block text-left decoration-none animate-fade-up" style="animation-delay: 0.3s;">
                <div class="entity-card h-64 flex flex-col p-5 group cursor-pointer hover:bg-white/90">
                    <div
                        class="w-14 h-14 rounded-2xl bg-ortho flex items-center justify-center mb-4 shadow-sm icon-circle group-hover:shadow-md">
                        <i class="fas fa-user-md text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-xl font-bold text-gray-800 mb-1 group-hover:text-blue-700 transition-colors">
                            MLSIPL</h2>
                        <h3 class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-2">Orthopedics</h3>
                        <p class="text-xs text-gray-500 leading-relaxed">
                            Meril Life Science India Pvt Ltd. <br>
                            Domestic orthopedics inventory management.
                        </p>
                    </div>
                    <div
                        class="mt-3 flex items-center text-blue-600 text-xs font-bold group-hover:translate-x-1 transition-transform">
                        Launch Tool <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </div>
            </a>

            <!-- Card 3: MLSIPL Cardio -->
            <a href="Cardio-Validator.html" onclick="handleToolClick(event, 'cardio_settings', 'Cardio-Validator.html')"
                class="block text-left decoration-none animate-fade-up" style="animation-delay: 0.4s;">
                <div class="entity-card h-64 flex flex-col p-5 group cursor-pointer hover:bg-white/90">
                    <div
                        class="w-14 h-14 rounded-2xl bg-cardio flex items-center justify-center mb-4 shadow-sm icon-circle group-hover:shadow-md">
                        <i class="fas fa-heartbeat text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-xl font-bold text-gray-800 mb-1 group-hover:text-rose-700 transition-colors">
                            MLSIPL</h2>
                        <h3 class="text-xs font-bold text-rose-600 uppercase tracking-wider mb-2">Cardio</h3>
                        <p class="text-xs text-gray-500 leading-relaxed">
                            Cardiovascular division. <br>
                            Stents, balloons, and cardiac inventory validation.
                        </p>
                    </div>
                    <div
                        class="mt-3 flex items-center text-rose-600 text-xs font-bold group-hover:translate-x-1 transition-transform">
                        Launch Tool <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </div>
            </a>

            <!-- Card 4: MDPL Diagnostic -->
            <a href="MDPL-Validator.html" onclick="handleToolClick(event, 'mdpl_settings', 'MDPL-Validator.html')"
                class="block text-left decoration-none animate-fade-up" style="animation-delay: 0.5s;">
                <div class="entity-card h-64 flex flex-col p-5 group cursor-pointer hover:bg-white/90">
                    <div
                        class="w-14 h-14 rounded-2xl bg-diag flex items-center justify-center mb-4 shadow-sm icon-circle group-hover:shadow-md">
                        <i class="fas fa-microscope text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-xl font-bold text-gray-800 mb-1 group-hover:text-green-700 transition-colors">
                            MDPL</h2>
                        <h3 class="text-xs font-bold text-green-600 uppercase tracking-wider mb-2">Diagnostic</h3>
                        <p class="text-xs text-gray-500 leading-relaxed">
                            Meril Diagnostics Pvt Ltd. <br>
                            Reagents, analyzers, and diagnostic equipment check.
                        </p>
                    </div>
                    <div
                        class="mt-3 flex items-center text-green-600 text-xs font-bold group-hover:translate-x-1 transition-transform">
                        Launch Tool <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </div>
            </a>

        </div>

        <div class="mt-12 text-center animate-fade-up" style="animation-delay: 0.8s;">
            <div
                class="inline-block px-8 py-3 rounded-full bg-black/60 backdrop-blur-xl border border-white/20 shadow-[0_0_20px_rgba(0,0,0,0.5)] hover:bg-black/70 hover:scale-105 transition-all duration-300">
                <p class="text-xs font-bold text-blue-300 tracking-wider mb-2 uppercase font-mono drop-shadow-md">
                    Developed by <span class="text-blue-400 font-extrabold text-shadow-blue">Ahmedabad Team</span> <i
                        class="fas fa-code text-blue-400 ml-1"></i>
                </p>
                <div class="h-px bg-gradient-to-r from-transparent via-blue-500/50 to-transparent w-full mx-auto my-2">
                </div>
                <p class="text-[11px] font-bold text-gray-300 tracking-widest uppercase mb-1">
                    Dedicated To
                </p>
                <p class="text-sm font-black text-white text-shadow-sm tracking-wide">
                    MERIL-AHMEDABAD WAREHOUSE
                </p>
            </div>

            <p class="mt-6 text-white/80 text-lg font-serif italic drop-shadow-md tracking-wide">
                "Meril - More to Life"
            </p>

            <p class="mt-8 text-[10px] text-gray-400/80 font-mono">
                &copy; 2026 Meril-V Inventory Systems. All Secure.
            </p>
        </div>
    </div>

    <!-- WHAT'S NEW MODAL -->
    <div id="newFeatureModal"
        class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 animate-fade-up">

            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full bg-white/10 skew-y-6 transform origin-bottom-left">
                </div>
                <div
                    class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-md shadow-inner">
                    <i class="fas fa-rocket text-3xl text-white drop-shadow-md"></i>
                </div>
                <h2 class="text-2xl font-bold text-white tracking-tight">System Update v7.3</h2>
                <p class="text-blue-100 text-sm font-medium mt-1">Faster, Smarter, Better.</p>
            </div>

            <!-- Content -->
            <div class="p-6 space-y-5">

                <!-- Feature 1 -->
                <div class="flex items-start gap-4">
                    <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-shield-alt text-blue-600 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-sm">Admin Power Boost</h3>
                        <p class="text-xs text-gray-500 mt-1">Direct admin access from login, user management, and
                            seamless navigation.</p>
                    </div>
                </div>

                <!-- Feature 2 -->
                <div class="flex items-start gap-4">
                    <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-users text-green-600 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-sm">User Management</h3>
                        <p class="text-xs text-gray-500 mt-1">Admins can now instantly create and manage user accounts
                            directly from the dashboard.</p>
                    </div>
                </div>

                <!-- Feature 3 -->
                <div class="flex items-start gap-4">
                    <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-magic text-purple-600 text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-sm">Visual Polish</h3>
                        <p class="text-xs text-gray-500 mt-1">Enjoy a refined UI with enhanced visibility, smoother
                            animations, and a fresh look.</p>
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div class="p-6 bg-gray-50 border-t flex justify-center">
                <button onclick="closeNewFeatureModal()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
                    Awesome, Let's Go! ðŸš€
                </button>
            </div>

        </div>
    </div>

    <script>
        // Check local storage for update version
        const UPDATE_VERSION = "v7.4";

        document.addEventListener('DOMContentLoaded', () => {
            const lastSeen = localStorage.getItem('merill_update_seen');
            if (lastSeen !== UPDATE_VERSION) {
                // Show modal with a slight delay for effect
                setTimeout(() => {
                    document.getElementById('newFeatureModal').classList.remove('hidden');
                }, 500);
            }
        });

        function closeNewFeatureModal() {
            const modal = document.getElementById('newFeatureModal');
            modal.classList.add('opacity-0', 'scale-95'); // Fade out animation
            setTimeout(() => {
                modal.classList.add('hidden');
                localStorage.setItem('merill_update_seen', UPDATE_VERSION);
            }, 300);
        }
    </script>
    <!-- MAINTENANCE MODAL -->
    <div id="maintenanceModal"
        class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 animate-fade-up">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-hard-hat text-3xl text-yellow-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Under Construction</h3>
                <p class="text-sm text-gray-500 mb-6">
                    This tool is currently being updated or is in maintenance mode.
                    Please check back later or contact your administrator.
                </p>
                <div class="flex justify-center gap-3">
                    <button onclick="document.getElementById('maintenanceModal').classList.add('hidden')"
                        class="px-5 py-2 bg-gray-100 text-gray-700 font-bold rounded-lg hover:bg-gray-200 transition-colors">
                        Close
                    </button>
                    <!-- Admin Override (Hidden functionality) -->
                    <button id="adminOverrideBtn" onclick="forceNavigate()"
                        class="hidden px-5 py-2 bg-yellow-600 text-white font-bold rounded-lg hover:bg-yellow-700 transition-colors">
                        Admin Access
                    </button>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 border-t border-gray-100">
                <p class="text-xs text-center text-gray-400">Error Code: 503_MAINTENANCE</p>
            </div>
        </div>
    </div>

    <script>
        // --- TOOL ACCESS CONTROL ---
        let toolConfigs = {};
        let pendingUrl = ""; // Store URL for admin override

        async function initToolAccess() {
            try {
                // Fetch all tool configs in one go
                const { data, error } = await sbClient
                    .from('global_config')
                    .select('key, value')
                    .in('key', ['mhpl_settings', 'mlsipl_settings', 'cardio_settings', 'mdpl_settings']);

                if (data) {
                    data.forEach(item => {
                        toolConfigs[item.key] = item.value; // Store the whole value object
                    });
                }

                // Show Admin Override if user is admin
                const user = await sbClient.auth.getUser();
                if (user?.data?.user) {
                    const { data: profile } = await sbClient
                        .from('profiles')
                        .select('role')
                        .eq('id', user.data.user.id)
                        .single();

                    if (profile?.role === 'admin') {
                        document.getElementById('adminOverrideBtn').classList.remove('hidden');
                    }
                }

            } catch (e) {
                console.error("Failed to load tool configs:", e);
            }
        }

        function handleToolClick(event, key, url) {
            // Default to enabled if config missing (fail open or closed? Closed is safer for maintenance, Open for UX. Let's fail Open for now to avoid locking out on error, unless explicitly disabled)
            const config = toolConfigs[key];
            const isEnabled = config ? config.enabled : true; // Default True

            if (!isEnabled) {
                event.preventDefault();
                pendingUrl = url;
                document.getElementById('maintenanceModal').classList.remove('hidden');
            }
            // If enabled, let the <a> tag handle navigation naturally
        }

        function forceNavigate() {
            if (pendingUrl) window.location.href = pendingUrl;
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initToolAccess();
            // We can also check for announcments here
        });
    </script>
</body>

</html>